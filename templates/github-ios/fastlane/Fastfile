# Fastfile for iOS CI/CD
# Template from github-starterpack

default_platform(:ios)

# Configuration - Update these values for your project
APP_IDENTIFIER = "{{BUNDLE_IDENTIFIER}}"
TEAM_ID = "{{TEAM_ID}}"
SCHEME = "{{SCHEME_NAME}}"
PROJECT = "{{PROJECT_NAME}}.{{WORKSPACE_EXT}}"

platform :ios do

  desc "Run all tests"
  lane :test do
    scan(
      scheme: SCHEME,
      devices: ["{{SIMULATOR_DEVICE}}"],
      clean: true,
      code_coverage: true,
      output_types: "html,junit"
    )
  end

  desc "Build the app for testing"
  lane :build do
    gym(
      scheme: SCHEME,
      configuration: "Debug",
      export_method: "development",
      skip_codesigning: true,
      skip_archive: true
    )
  end

  desc "Deploy to TestFlight"
  lane :beta do
    # Ensure we're on a clean state
    ensure_git_status_clean unless ENV["CI"]

    # Setup App Store Connect API
    app_store_connect_api_key(
      key_id: ENV["ASC_KEY_ID"],
      issuer_id: ENV["ASC_ISSUER_ID"],
      key_filepath: "~/.appstoreconnect/private_keys/AuthKey_#{ENV['ASC_KEY_ID']}.p8",
      in_house: false
    )

    # Increment build number
    if ENV["BUILD_NUMBER"] && !ENV["BUILD_NUMBER"].empty?
      increment_build_number(build_number: ENV["BUILD_NUMBER"])
    else
      increment_build_number(
        build_number: latest_testflight_build_number + 1
      )
    end

    # Build the app
    gym(
      scheme: SCHEME,
      configuration: "Release",
      export_method: "app-store",
      export_options: {
        provisioningProfiles: {
          APP_IDENTIFIER => "match AppStore #{APP_IDENTIFIER}"
        }
      },
      output_directory: "./build",
      output_name: "{{PROJECT_NAME}}.ipa"
    )

    # Upload to TestFlight
    pilot(
      skip_waiting_for_build_processing: true,
      skip_submission: true,
      distribute_external: false
    )

    # Clean up
    clean_build_artifacts

    UI.success("Successfully deployed to TestFlight! ðŸš€")
  end

  desc "Deploy to App Store"
  lane :release do
    # Ensure we're on main branch
    ensure_git_branch(branch: "{{MAIN_BRANCH}}")
    ensure_git_status_clean

    # Setup App Store Connect API
    app_store_connect_api_key(
      key_id: ENV["ASC_KEY_ID"],
      issuer_id: ENV["ASC_ISSUER_ID"],
      key_filepath: "~/.appstoreconnect/private_keys/AuthKey_#{ENV['ASC_KEY_ID']}.p8",
      in_house: false
    )

    # Get version from Xcode project
    version = get_version_number(target: SCHEME)

    # Increment build number
    increment_build_number(
      build_number: latest_testflight_build_number + 1
    )

    # Build the app
    gym(
      scheme: SCHEME,
      configuration: "Release",
      export_method: "app-store"
    )

    # Upload to App Store
    deliver(
      submit_for_review: false,
      automatic_release: false,
      force: true,
      skip_screenshots: true,
      skip_metadata: false
    )

    # Tag the release
    add_git_tag(tag: "v#{version}")
    push_git_tags

    UI.success("Successfully submitted to App Store! ðŸŽ‰")
  end

  desc "Sync certificates and profiles"
  lane :sync_certs do
    match(
      type: "appstore",
      app_identifier: APP_IDENTIFIER,
      readonly: is_ci
    )
    match(
      type: "development",
      app_identifier: APP_IDENTIFIER,
      readonly: is_ci
    )
  end

  desc "Upload dSYM files to Crashlytics"
  lane :upload_symbols do
    download_dsyms(
      version: "latest"
    )
    upload_symbols_to_crashlytics(
      gsp_path: "./{{PROJECT_NAME}}/GoogleService-Info.plist"
    )
    clean_build_artifacts
  end

  # Error handling
  error do |lane, exception|
    UI.error("Error in lane #{lane}: #{exception.message}")
  end
end
